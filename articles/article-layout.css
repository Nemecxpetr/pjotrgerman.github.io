:root {
  color-scheme: light dark;
  --bg: #faf5ef;
  --fg: #0b0b0b;
  --muted: rgba(11, 11, 11, 0.7);
  --hairline: rgba(11, 11, 11, 0.14);
  --panel: rgba(11, 11, 11, 0.03);
  --map-bg: #f6f0e9;
  --map-grid: rgba(11, 11, 11, 0.05);
  --map-node-bg: #0b0b0b;
  --map-node-border: #2f2f2f;
  --map-node-font: #0b0b0b;
  --map-edge: rgba(11, 11, 11, 0.26);
  --map-edge-highlight: #0b0b0b;
  --accent-blue: #1daada;
  --focus: rgba(11, 11, 11, 0.1);
  --error: #b7372d;
  --text-block-bg: rgba(250, 245, 239, 0.84);
  --mention-underline: rgba(11, 11, 11, 0.36);
  --font-main: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --pane-divider-size: 12px;
  --column-divider-size: 12px;
  --map-pane-size: 50dvh;
  --article-max-width: 880px;
  --article-pane-size: 58vw;
  --desktop-header-min: 74px;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0b0b0b;
    --fg: #faf5ef;
    --muted: rgba(250, 245, 239, 0.74);
    --hairline: rgba(250, 245, 239, 0.16);
    --panel: rgba(250, 245, 239, 0.04);
    --map-bg: #101010;
    --map-grid: rgba(250, 245, 239, 0.06);
    --map-node-bg: #faf5ef;
    --map-node-border: #faf5ef;
    --map-node-font: #faf5ef;
    --map-edge: rgba(250, 245, 239, 0.34);
    --map-edge-highlight: #faf5ef;
    --accent-blue: #1daada;
    --focus: rgba(250, 245, 239, 0.1);
    --error: #ff9487;
    --text-block-bg: rgba(11, 11, 11, 0.73);
    --mention-underline: rgba(250, 245, 239, 0.42);
  }
}

* {
  box-sizing: border-box;
}

html,
body {
  margin: 0;
  height: 100%;
}

body {
  background: var(--bg);
  color: var(--fg);
  font-family: var(--font-main);
}

.mask-layer {
  position: fixed;
  inset: 0;
  display: grid;
  place-items: center;
  z-index: 0;
  pointer-events: none;
}

.mask-img {
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  opacity: 0;
  user-select: none;
  -webkit-user-drag: none;
}

#fx {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: 1;
  pointer-events: none;
}

.essay-layout {
  position: relative;
  z-index: 2;
  height: 100dvh;
  display: grid;
  grid-template-columns: 1fr;
  grid-template-rows:
    clamp(180px, var(--map-pane-size), calc(100dvh - 180px - var(--pane-divider-size)))
    var(--pane-divider-size)
    minmax(0, 1fr);
  grid-template-areas:
    "map"
    "pane-resizer"
    "article";
}

.desktop-page-header {
  display: none;
}

.map-pane {
  grid-area: map;
  background: var(--bg);
  padding: 1.25rem 1rem 0.8rem;
  display: grid;
  grid-template-rows: auto minmax(0, 1fr) auto;
  gap: 0.7rem;
  min-height: 0;
}

.map-header {
  display: grid;
  gap: 0.35rem;
}

.eyebrow {
  margin: 0;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font: 600 0.68rem/1.1 var(--font-main);
}

#article-title {
  margin: 0;
  color: var(--fg);
  font: 600 clamp(1rem, 2.7vw, 1.5rem)/1.1 var(--font-main);
  letter-spacing: -0.01em;
}

.subtitle {
  margin: 0;
  color: var(--muted);
  font: 400 0.84rem/1.4 var(--font-main);
}

.mind-map {
  min-height: 0;
  height: 100%;
  border: 1px solid var(--hairline);
  border-radius: 18px;
  background:
    linear-gradient(var(--map-grid) 1px, transparent 1px),
    linear-gradient(90deg, var(--map-grid) 1px, transparent 1px),
    var(--map-bg);
  background-size: 24px 24px, 24px 24px, auto;
  overflow: hidden;
}

.map-help {
  margin: 0;
  color: var(--muted);
  font: 400 0.74rem/1.35 var(--font-main);
}

.pane-resizer {
  grid-area: pane-resizer;
  position: relative;
  touch-action: none;
  cursor: row-resize;
  background: transparent;
}

.pane-resizer::before {
  content: "";
  position: absolute;
  inset: 50% 16px auto 16px;
  transform: translateY(-50%);
  height: 2px;
  border-radius: 999px;
  background: var(--hairline);
}

.pane-resizer:hover::before,
.pane-resizer:focus-visible::before {
  background: var(--accent-blue);
}

.pane-resizer:focus-visible {
  outline: none;
}

.is-resizing,
.is-resizing * {
  user-select: none !important;
}

.article-pane {
  grid-area: article;
  overflow-y: auto;
  scrollbar-gutter: stable both-edges;
  min-height: 0;
  background: transparent;
  color: var(--fg);
  padding: clamp(0.55rem, 2vw, 1.1rem) clamp(0.9rem, 3.2vw, 1.8rem) clamp(1rem, 4vw, 2.2rem);
}

.article-content {
  max-width: min(100%, var(--article-max-width));
  margin: 0 auto;
  display: grid;
  gap: 0.9rem;
  padding-top: var(--context-anchor-spacer-top, 0px);
  padding-bottom: var(--context-anchor-spacer-bottom, 0px);
}

.context-preview {
  grid-area: preview;
  display: none;
  min-height: 0;
  border: 1px solid var(--hairline);
  border-radius: 12px;
  background: var(--text-block-bg);
  padding: 0.72rem 0.82rem 0.86rem;
}

.column-resizer {
  grid-area: column-resizer;
  display: none;
  position: relative;
  touch-action: none;
  cursor: col-resize;
  background: transparent;
}

.column-resizer::before {
  content: "";
  position: absolute;
  inset: 16px auto 16px 50%;
  transform: translateX(-50%);
  width: 2px;
  border-radius: 999px;
  background: var(--hairline);
}

.column-resizer:hover::before,
.column-resizer:focus-visible::before {
  background: var(--accent-blue);
}

.column-resizer:focus-visible {
  outline: none;
}

.context-preview-title {
  margin: 0;
  color: var(--fg);
  font: 600 0.98rem/1.3 var(--font-main);
}

.context-preview-meta {
  margin: 0.28rem 0 0;
  color: var(--muted);
  font: 400 0.78rem/1.45 var(--font-main);
}

.context-preview-title:empty,
.context-preview-meta:empty {
  display: none;
}

.context-preview-body {
  margin-top: 0.56rem;
  display: grid;
  gap: 0.5rem;
}

.context-preview-body p {
  margin: 0;
  color: var(--fg);
  font: 400 0.84rem/1.6 var(--font-main);
}

.article-meta {
  border-bottom: 1px solid var(--hairline);
  background: var(--text-block-bg);
  border-radius: 10px;
  padding: 0.7rem 0.85rem 0.9rem;
  padding-bottom: 1rem;
}

.article-meta p {
  margin: 0;
  color: var(--muted);
  font: 500 0.78rem/1.35 var(--font-main);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.article-section {
  display: grid;
  gap: 0.88rem;
  scroll-margin-top: 1rem;
  transition: background-color 260ms ease;
  border-radius: 10px;
  border: 1px solid var(--hairline);
  background: var(--text-block-bg);
  padding: 0.46rem 0.82rem 0.7rem;
}

.article-section.is-hidden {
  display: none;
}

.article-section.active {
  box-shadow: 0 0 0 1px var(--focus) inset;
}

.article-section h2 {
  margin: 0;
  color: var(--fg);
  font: 600 clamp(1rem, 2.2vw, 1.2rem)/1.2 var(--font-main);
}

.article-section p,
.article-section li {
  margin: 0;
  color: var(--fg);
  font: 400 0.95rem/1.7 var(--font-main);
  text-align: justify;
  text-justify: inter-word;
}

.article-section ul,
.article-section ol {
  margin: 0;
  padding-left: 1.2rem;
}

.article-section blockquote {
  margin: 0.25rem 0;
  padding: 0.1rem 0 0.1rem 0.75rem;
  border-left: 3px solid var(--hairline);
  color: var(--muted);
  font: 400 0.95rem/1.7 var(--font-main);
}

.article-section a {
  color: inherit;
  text-decoration: underline;
  text-underline-offset: 2px;
}

.context-shifted {
  transition: box-shadow 170ms ease, background-color 170ms ease;
  will-change: transform;
}

.context-shift-active {
  cursor: grab;
  border-radius: 10px;
  background: var(--panel);
  box-shadow: 0 0 0 1px var(--focus) inset;
  padding: 0.14rem 0.2rem;
}

.context-shift-active.is-dragging {
  cursor: grabbing;
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
}

.graph-mention {
  text-decoration: underline;
  text-decoration-style: dotted;
  text-decoration-thickness: 0.07em;
  text-decoration-color: var(--mention-underline);
  text-underline-offset: 0.18em;
  transition: background-color 140ms ease, text-decoration-color 140ms ease;
}

.graph-mention:hover,
.graph-mention:focus-visible,
.graph-mention.is-active {
  text-decoration-style: solid;
  text-decoration-color: currentColor;
  background: var(--focus);
}

.graph-thread {
  cursor: pointer;
}

.graph-thread.is-thread-active {
  text-decoration-style: solid;
  background: var(--focus);
}

.loading,
.error {
  margin: 0;
  font: 500 0.9rem/1.45 var(--font-main);
}

.error {
  color: var(--error);
}

.sound-toggle {
  position: fixed;
  right: calc(env(safe-area-inset-right, 0px) + 10px);
  top: calc(env(safe-area-inset-top, 0px) + 10px);
  z-index: 20;
  border: 1px solid var(--hairline);
  border-radius: 999px;
  background: var(--bg);
  color: var(--fg);
  font-family: var(--font-main);
  font-size: 12px;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  padding: 8px 12px;
  cursor: pointer;
  pointer-events: auto;
}

.sound-toggle:hover {
  border-color: currentColor;
  background: var(--panel);
}

.sound-toggle:focus-visible {
  outline: 2px solid currentColor;
  outline-offset: 2px;
}

@media (max-width: 900px) {
  .essay-layout {
    --pane-divider-size: 10px;
    --map-pane-size: 50dvh;
    grid-template-rows:
      clamp(160px, var(--map-pane-size), calc(100dvh - 170px - var(--pane-divider-size)))
      var(--pane-divider-size)
      minmax(0, 1fr);
  }

  .map-pane,
  .mind-map {
    touch-action: none;
    overscroll-behavior: contain;
  }

  .map-pane {
    padding: 0.9rem 0.8rem 0.6rem;
  }

  .mind-map {
    border-radius: 14px;
  }

  .article-pane {
    padding: 0.62rem 0.92rem 1.2rem;
  }
}

@media (min-width: 1200px) {
  .essay-layout {
    grid-template-columns:
      minmax(520px, var(--article-pane-size))
      var(--column-divider-size)
      minmax(320px, 1fr);
    grid-template-rows:
      minmax(var(--desktop-header-min), auto)
      clamp(210px, var(--map-pane-size), calc(100dvh - 290px - var(--pane-divider-size)))
      var(--pane-divider-size)
      minmax(160px, 1fr);
    grid-template-areas:
      "desktop-header desktop-header desktop-header"
      "article column-resizer map"
      "article column-resizer pane-resizer"
      "article column-resizer preview";
  }

  .desktop-page-header {
    grid-area: desktop-header;
    display: grid;
    align-content: center;
    gap: 0.3rem;
    padding: 0.6rem 1.1rem 0.42rem;
    border-bottom: 1px solid var(--hairline);
    background: color-mix(in srgb, var(--bg) 90%, transparent);
    backdrop-filter: blur(2px);
  }

  .desktop-page-header .eyebrow,
  .desktop-page-header .subtitle,
  .desktop-page-header #article-title-desktop {
    margin: 0;
  }

  .desktop-page-header #article-title-desktop {
    color: var(--fg);
    font: 600 clamp(1.02rem, 1.9vw, 1.45rem)/1.1 var(--font-main);
    letter-spacing: -0.01em;
  }

  .map-header {
    display: none;
  }

  .article-pane {
    padding-left: clamp(1rem, 2.2vw, 2.2rem);
    padding-right: clamp(1rem, 2.2vw, 2.2rem);
  }

  .article-content {
    margin-left: auto;
    margin-right: 0;
  }

  .map-help {
    display: none;
  }

  .column-resizer {
    display: block;
  }

  .context-preview {
    display: block;
    max-height: none;
    overflow: auto;
    margin: 0.3rem 0.9rem 0.9rem;
  }

  .map-pane {
    padding: 1rem 0.9rem 0.55rem;
  }
}
